<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Codeforces 用户参赛进化图</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    #chart {
      width: 1440px;
      height: 900px;
      margin-bottom: 20px;
    }
    #detail-container {
      width: 1440px;
      margin-top: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
    }
    th {
      background: #f0f0f0;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h2>Codeforces 用户参赛 Rating 变化</h2>
  <div id="chart"></div>

  <div id="detail-container" class="hidden">
    <h3 id="detail-title"></h3>
    <table id="detail-table">
      <thead>
        <tr>
          <th>排名</th><th>旧 Rating</th><th>新 Rating</th>
          <th>头衔变化</th><th>题号</th><th>满分</th><th>得分</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const colors = {
      gray: '#808080',
      green: '#008000',
      cyan: '#03A89E',
      blue: '#0000FF',
      purple: '#AA00AA',
      orange: '#FF8C00',
      red: '#FF0000',
      yellow: '#FFD700'
    };

    function getColorByRank(rank) {
      if (rank === "Legendary Grandmaster") return colors.red;
      if (rank === "International Grandmaster") return colors.orange;
      if (rank === "Grandmaster") return colors.orange;
      if (rank === "International Master") return colors.purple;
      if (rank === "Master") return colors.purple;
      if (rank === "Candidate Master") return colors.blue;
      if (rank === "Expert") return colors.cyan;
      if (rank === "Specialist") return colors.green;
      if (rank === "Pupil") return colors.green;
      if (rank === "Newbie") return colors.gray;
      return '#000';
    }

    fetch('user_evolution.json')
      .then(res => res.json())
      .then(data => {
        const chart = echarts.init(document.getElementById('chart'));

        const xData = data.map(d => d.contestName + ' (#' + d.contestId + ')');
        const yData = data.map(d => d.newRating);

        const rankNames = data.map(d => d.rankAfter);
        const colorsByRank = rankNames.map(getColorByRank);

        chart.setOption({
          title: { text: 'Rating 进化折线图', left: 'center' },
          tooltip: {
            trigger: 'axis',
            formatter: function (params) {
              const i = params[0].dataIndex;
              const d = data[i];
              return `
<b>${d.contestName}</b><br/>
ID: ${d.contestId}<br/>
Rating: ${d.oldRating} → ${d.newRating}<br/>
头衔: <span style="color:${getColorByRank(d.rankAfter)}">${d.rankBefore}</span> → <span style="color:${getColorByRank(d.rankAfter)}">${d.rankAfter}</span>
              `;
            }
          },
          xAxis: {
            type: 'category',
            data: xData,
            axisLabel: { rotate: 45, interval: 0 }
          },
          yAxis: {
            type: 'value',
            name: 'Rating'
          },
          series: [{
            name: 'Rating',
            type: 'line',
            data: yData,
            symbol: 'circle',
            symbolSize: 10,
            lineStyle: { width: 2, color: 'red' },
            itemStyle: { color: 'deepskyblue' },
            emphasis: {
              itemStyle: {
                borderColor: '#000',
                borderWidth: 2
              }
            },
            label: { show: false }
          }]
        });

        window.addEventListener('resize', () => chart.resize());

        chart.on('click', function (params) {
          const i = params.dataIndex;
          const d = data[i];

          const table = document.getElementById('detail-table').querySelector('tbody');
          table.innerHTML = '';

          const title = document.getElementById('detail-title');
          title.innerHTML = `比赛详情：${d.contestName} (#${d.contestId})`;

          const probs = d.problems || [];
          probs.forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${d.rank}</td>
              <td>${d.oldRating}</td>
              <td>${d.newRating}</td>
              <td><span style="color:${getColorByRank(d.rankAfter)}">${d.rankBefore} → ${d.rankAfter}</span></td>
              <td>${p.index}</td>
              <td>${p.maxPoints || '-'}</td>
              <td>${p.points || '-'}</td>
            `;
            table.appendChild(row);
          });

          document.getElementById('detail-container').classList.remove('hidden');
          document.getElementById('detail-container').scrollIntoView({ behavior: 'smooth' });
        });
      });
  </script>
</body>
</html>
